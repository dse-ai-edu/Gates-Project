<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Step 1/2: Base Style and Feedback Template</title>
    <link rel="shortcut icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/general.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/feedback_input_function.css') }}">
</head>

<body>
    <h1 class="page-title">Auto Feedback Generation</h1>
    <div class="container">
        <div class="left-section">
            <h2 style="text-decoration: underline;">Setting Step: 1 of 2</h2>
            <p id="save-status"></p>
            
            <div class="traverse-buttons">
                <button class="t-button" onclick="saveAndProceed_step1()">Save</button>
                <button class="t-button" style="background-color: #ff9800;" onclick="window.feedbackInputFunctions.loadPriorSetting()">Load Prior Setting</button>
                <!-- <button class="t-button" onclick="resetSection()">Reset</button> -->
            </div>
        </div>

        <div class="right-section">
            <!-- Component 1: Style Keywords -->
            <div class="content-section" id="style-keywords-section">
                <h2>Set Feedback Keywords</h2>
                <p>Choose keywords that best describe your preferred feedback style: </p>
                <div id="feedback-function-1-container"></div>
            </div>

            <hr style="margin: 2rem 0; border: 1px solid #ddd;">

            <!-- Component 2: Feedback Templates -->
            <div class="content-section" id="feedback-templates-section">
                <h2>Templates of Feedback Response</h2>
                <div id="feedback-function-2-container"></div>
            </div>
        </div>
    </div>
    
    <script src="{{ url_for('static', filename='js/feedback_input_function.js') }}"></script>
    <script>
        // User authentication check
        function checkAuthentication() {
            const user = localStorage.getItem('user');
            if (!user) {
                alert('Please login first to access this page.');
                window.location.href = '/login';
                return false;
            }
            return true;
        }
        
        // Initialize authentication check on page load
        if (!checkAuthentication()) {
            throw new Error('Authentication required');
        }
        
        // Load components
        async function loadComponents() {
            try {
                // Load component 1
                const response1 = await fetch("{{ url_for('static', filename='components/feedback_function_1.html') }}");
                const html1 = await response1.text();
                document.getElementById('feedback-function-1-container').innerHTML = html1;
                
                // Load component 2
                const response2 = await fetch("{{ url_for('static', filename='components/feedback_function_2.html') }}");
                const html2 = await response2.text();
                document.getElementById('feedback-function-2-container').innerHTML = html2;
                
                // Initialize components after loading
                setTimeout(() => {
                    window.feedbackInputFunctions.initStyleKeywordsComponent();
                    window.feedbackInputFunctions.initFeedbackTemplatesComponent();
                }, 100);
                
            } catch (error) {
                console.error('Failed to load components:', error);
            }
        }
        
        // Save and proceed to next step
        function saveAndProceed_step1() {
            const selectedStyles = window.feedbackInputFunctions.getSelectedStyles();
            const templateTexts = window.feedbackInputFunctions.getTemplateTexts();
            
            if (selectedStyles.length === 0) {
                alert("â— Please select at least one Keywords of Feedback Style.");
                return;
            }
            if (templateTexts.length === 0) {
                alert("â— Please enter at least one Feedback Template Item; you could press the button \"Default Template\" if you do not want to set.");
                return;
            }
            // Validate feedback templates contain at least one English letter
            const hasValidTemplate = templateTexts.some(template => {
                return /[a-zA-Z]/.test(template);
            });
            
            if (!hasValidTemplate) {
                alert("â— Template is not valid; you could press the button \"DEFAULT Template\" if you do not want to set.");
                return;
            }

            // Show saving status
            const status = document.getElementById('save-status');
            status.textContent = 'ðŸ’¾ Saved to local storage';
            status.style.color = 'green';
            
            // Navigate to step2 after a brief delay
            setTimeout(() => {
                window.location.href = '/step2';
            }, 1000);
        }
        
        // Reset all selections
        function resetSection() {
            // Reset components
            window.feedbackInputFunctions.resetStyles();
            
            // Reset templates to default
            const templateContainer = document.getElementById('template-container');
            if (templateContainer) {
                templateContainer.innerHTML = `
                    <div class="template-row">
                        <input type="text" class="template-input" placeholder="enter one template item (max 50 characters)" maxlength="50" value="strength">
                        <button class="delete-btn" onclick="deleteTemplate(this)">Ã—</button>
                    </div>
                    <div class="template-row">
                        <input type="text" class="template-input" placeholder="enter one template item (max 50 characters)" maxlength="50" value="weakness">
                        <button class="delete-btn" onclick="deleteTemplate(this)">Ã—</button>
                    </div>
                    <div class="template-row">
                        <input type="text" class="template-input" placeholder="enter one template item (max 50 characters)" maxlength="50" value="improvement">
                        <button class="delete-btn" onclick="deleteTemplate(this)">Ã—</button>
                    </div>
                `;
                
                // Re-initialize templates component
                window.feedbackInputFunctions.initFeedbackTemplatesComponent();
            }
            
            // Clear sessionStorage
            sessionStorage.removeItem('step1_style_keywords');
            sessionStorage.removeItem('step1_feedback_templates');
            
            // Clear status
            const status = document.getElementById('save-status');
            status.textContent = '';
            status.style.color = '';
        }
        
        // Initialize page
        window.addEventListener('load', function() {
            sessionStorage.removeItem('predefined_conf');
            loadComponents();
        });
    </script>
</body>
</html>
