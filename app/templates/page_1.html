<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Keywords and Templates</title>

    <link rel="shortcut icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/general.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/feedback_input_function.css') }}">
</head>

<body data-page="page_1">

<h1 class="page-title">Auto Feedback Generation</h1>

<div class="container">

    <!-- ================= Left Control Panel ================= -->
    <div class="left-section">
        <h2 style="text-decoration: underline;">Keyword Setting</h2>
        <p id="save-status"></p>

        <div class="traverse-buttons">
            <button class="t-button" onclick="saveAndProceed_page1()">Save</button>
            <!-- <button class="t-button"
                    style="background-color:#ff9800;"
                    onclick="window.feedbackInputFunctions.loadPriorSetting()">
                Load Prior Setting
            </button> -->
        </div>
    </div>

    <!-- ================= Right Content Panel ================= -->
    <div class="right-section">

        <!-- ===== Component 1: Feedback Keywords (step11–step14) ===== -->
        <div class="content-section" id="style-keywords-section">
            <h2>Set Feedback Keywords</h2>
            <p>Choose one keyword from each group:</p>

            <div class="style-keywords-row">
                <div class="style-keywords-col" id="feedback-function-1A-container"></div>
                <div class="style-keywords-col" id="feedback-function-1B-container"></div>
                <div class="style-keywords-col" id="feedback-function-1C-container"></div>
                <div class="style-keywords-col" id="feedback-function-1D-container"></div>
            </div>
        </div>

        <hr style="margin:2rem 0; border:1px solid #ddd;">

        <!-- ===== Component 2: Feedback Templates (step2, read-only) ===== -->
        <div class="content-section" id="feedback-templates-section">
            <h2>Templates of Feedback Response</h2>
            <div id="feedback-function-2-container"></div>
        </div>

    </div>
</div>

<!-- ================= Shared Logic ================= -->
<script src="{{ url_for('static', filename='js/feedback_input_function.js') }}"></script>

<script>
/* ---------- Authentication ---------- */
(function checkAuthentication() {
    const user = localStorage.getItem('user');
    if (!user) {
        alert('Please login first.');
        window.location.href = '/login';
        throw new Error('Authentication required');
    }
})();

/* ---------- Load Components ---------- */
async function loadComponents() {
    try {
        const map = [
            ['feedback-function-1A-container', 'components/feedback_function_1A.html'],
            ['feedback-function-1B-container', 'components/feedback_function_1B.html'],
            ['feedback-function-1C-container', 'components/feedback_function_1C.html'],
            ['feedback-function-1D-container', 'components/feedback_function_1D.html'],
            ['feedback-function-2-container',  'components/feedback_function_2.html']
        ];

        for (const [id, path] of map) {
            const r = await fetch(`{{ url_for('static', filename='') }}${path}`);
            document.getElementById(id).innerHTML = await r.text();
        }

        const init = () => {
            initStyleKeywordsComponent();
            initFeedbackTemplatesComponent();
        };

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }

    } catch (e) {
        console.error('Component loading failed:', e);
    }
}


/* ---------- Save & Proceed ---------- */
function saveAndProceed_page1() {
    const steps = ['step11', 'step12', 'step13', 'step14'];
    const missing = steps.filter(k => !sessionStorage.getItem(k));

    if (missing.length > 0) {
        alert('❗ Please select one keyword in each group.');
        return;
    }

    const step2 = sessionStorage.getItem('step2');
    if (!step2 || !/[a-zA-Z]/.test(step2)) {
        alert('❗ Feedback template is invalid.');
        return;
    }

    const status = document.getElementById('save-status');
    status.textContent = '✔ Saved';
    status.style.color = 'green';

    setTimeout(() => {
        window.location.href = '/page_2';
    }, 800);
}

/* ---------- Init ---------- */
window.addEventListener('load', () => {
    loadComponents();
});
</script>

</body>
</html>
