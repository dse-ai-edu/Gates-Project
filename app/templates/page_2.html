<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Feedback Pattern</title>

    <link rel="shortcut icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/general.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/feedback_input_function.css') }}">
</head>

<body data-page="page_2">

<h1 class="page-title">Auto Feedback Generation</h1>

<div class="container">

    <!-- ================= Left Control Panel ================= -->
    <div class="left-section">
        <h2 style="text-decoration: underline;">Setting Step: 2</h2>
        <p id="save-status"></p>

        <ul class="instruction-list">
            <li>Select your <b>Feedback Pattern</b></li>
            <li>(Optional) Provide a <b>Custom Feedback Pattern</b></li>
        </ul>

        <div class="traverse-buttons">
            <button class="t-button" onclick="goBack()">Back</button>
            <button class="t-button" onclick="saveAndProceed_page2()">Save</button>
            <button class="t-button"
                    style="background-color:#ff9800;"
                    onclick="window.feedbackInputFunctions.loadPriorSetting()">
                Load Prior Setting
            </button>
        </div>
    </div>

    <!-- ================= Right Content Panel ================= -->
    <div class="right-section">

        <!-- ===== Component 3: Feedback Pattern (step3 / step3A) ===== -->
        <div class="content-section" id="feedback-pattern-section">
            <div id="feedback-function-3-container"></div>
        </div>

    </div>
</div>

<!-- ================= Shared Logic ================= -->
<script src="{{ url_for('static', filename='js/feedback_input_function.js') }}"></script>

<script>
/* ---------- Authentication ---------- */
(function checkAuthentication() {
    const user = localStorage.getItem('user');
    if (!user) {
        alert('Please login first.');
        window.location.href = '/login';
        throw new Error('Authentication required');
    }
})();

/* ---------- Load Component ---------- */
async function loadComponents() {
    try {
        const r = await fetch("{{ url_for('static', filename='components/feedback_function_3.html') }}");
        document.getElementById('feedback-function-3-container').innerHTML = await r.text();

        /* initialize  */
        setTimeout(() => {
            window.feedbackInputFunctions.initTeachingStyleComponent();
        }, 100);

    } catch (e) {
        console.error('Component loading failed:', e);
    }
}

/* ---------- Navigation ---------- */
function goBack() {
    window.location.href = '/page_1';
}

/* ---------- Save & Proceed ---------- */
function saveAndProceed_page2() {
    const step3  = sessionStorage.getItem('step3') || '';
    const step3A = sessionStorage.getItem('step3A') || '';

    if (!step3 && !step3A) {
        alert('❗ Please select a feedback pattern or provide a custom one.');
        return;
    }

    const status = document.getElementById('save-status');
    status.textContent = '✔ Saved';
    status.style.color = 'green';

    setTimeout(() => {
        window.location.href = '/page_final';
    }, 800);
}

/* ---------- Init ---------- */
window.addEventListener('load', () => {
    loadComponents();
});

/* ---------- Auto-clear save status ---------- */
document.addEventListener('change', () => {
    const status = document.getElementById('save-status');
    if (status.textContent) {
        status.textContent = '';
        status.style.color = '';
    }
});
</script>

</body>
</html>
