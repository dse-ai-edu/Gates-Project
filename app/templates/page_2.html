<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Feedback Pattern</title>

    <link rel="shortcut icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/general.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/feedback_input_function.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/generation.css') }}">
</head>

<body data-page="page_2">

<h1 class="page-title">Auto Feedback Generation</h1>

<div class="container">

    <!-- ================= Left Control Panel ================= -->
    <div class="left-section">
        <h2 style="text-decoration: underline;">Pattern Setting</h2>
        <p id="save-status"></p>

        <ul class="instruction-list">
            <li>Select your <b>Feedback Pattern</b></li>
            <li>(Optional) Provide a <b>Custom Feedback Pattern</b></li>
        </ul>

        <div class="traverse-buttons">
            <button class="back-button" onclick="goBack()">Back</button>
            <button class="t-button" onclick="saveAndProceed_page2()">Save</button>
            <!--
            <button class="t-button"
                    style="background-color:#ff9800;"
                    onclick="window.feedbackInputFunctions.loadPriorSetting()">
                Load Prior Setting
            </button>
            -->
        </div>
    </div>

    <!-- ================= Right Content Panel ================= -->
    <div class="right-section">

        <!-- ===== Component 3: Feedback Pattern (step3 / step3A) ===== -->
        <div class="content-section" id="feedback-pattern-section">

            <!--  include pattern  -->
            {% include "components/feedback_function_3.html" %}

        </div>

    </div>
</div>

<!-- ================= Shared Logic ================= -->
<script src="{{ url_for('static', filename='js/feedback_input_function.js') }}"></script>

<script>
/* ---------- Authentication ---------- */
(function checkAuthentication() {
    const user = localStorage.getItem('user');
    if (!user) {
        alert('Please login first.');
        window.location.href = '/login';
        throw new Error('Authentication required');
    }
})();

/* ---------- Save & Proceed ---------- */
function saveAndProceed_page2() {
    const step3  = sessionStorage.getItem('step3') || '';
    const step3A = sessionStorage.getItem('step3A') || '';

    let tid = sessionStorage.getItem('tid');

    if (!tid) {
        tid = crypto.randomUUID();
        sessionStorage.setItem('tid', tid);
    }

    if (!step3 && !step3A) {
        alert("â— Please select a Feedback Pattern or provide a custom one.");
        return;
    }

    const configData = window.feedbackInputFunctions.getStoredConfigData();

    const styleData = {
        tid: tid,
        style_keywords: configData.style_keywords,
        feedback_templates: configData.feedback_templates,
        feedback_pattern: step3 || '',
        custom_rubric: step3A || ''
    };

    const status = document.getElementById('save-status');
    status.textContent = 'ðŸ’¾ Saving...';
    status.style.color = 'blue';

    fetch('/api/comment/update_style', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(styleData)
    })
    .then(response => {
        if (!response.ok) {
            throw Error('Save failed! Please try again.');
        }
        return response.json();
    })
    .then(result => {
        if (result.success) {
            status.textContent = 'âœ”ï¸ Saved';
            status.style.color = 'green';

            setTimeout(() => {
                window.location.href = '/page_demo';
            }, 1000);
        } else {
            throw Error('Save failed! Please try again.');
        }
    })
    .catch(error => {
        console.error(error);
        status.textContent = 'âŒ Save failed';
        status.style.color = 'red';
        alert(error);
    });
}

/* ---------- Navigation ---------- */
function goBack() {
    window.location.href = '/page_1';
}

/* ---------- Init ---------- */
window.addEventListener('DOMContentLoaded', () => {
    window.feedbackInputFunctions.initFeedbackPatternComponent();
});

/* ---------- Auto-clear save status ---------- */
document.addEventListener('change', () => {
    const status = document.getElementById('save-status');
    if (status.textContent) {
        status.textContent = '';
        status.style.color = '';
    }
});
</script>

</body>
</html>
