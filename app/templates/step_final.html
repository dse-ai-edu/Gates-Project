<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="shortcut icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <title>Auto Feedback Generation</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/general.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/feedback_input_function.css') }}">
    <style>
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        .section {
            background: #fff;
            padding: 2rem;
            margin-bottom: 2rem;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        .section h2 {
            margin-bottom: 1rem;
            font-size: 1.5rem;
        }

        select,
        textarea {
            width: 100%;
            padding: 0.75rem;
            font-size: 1rem;
            margin-top: 0.5rem;
            border: 1px solid #ccc;
            border-radius: 5px;
        }

        textarea {
            height: 150px;
            resize: vertical;
        }

        #result-textarea {
            height: 200px;
            background-color: #f8f9fa;
            color: #333;
        }

        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            font-size: 1rem;
            border-radius: 5px;
            cursor: pointer;
            margin-right: 0.5rem;
        }

        button:hover {
            background-color: #0056b3;
        }

        .back-button {
            background-color: #6c757d;
        }

        .back-button:hover {
            background-color: #545b62;
        }

        .save-button {
            background-color: #28a745;
        }

        .save-button:hover {
            background-color: #218838;
        }

        .navigation-buttons {
            margin-bottom: 2rem;
            text-align: center;
        }

        /* Four panel display improvements */
        .four-panel-layout {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
            position: relative;
            margin-top: 1rem;
        }

        .panel-display {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 1rem;
            background-color: #fafafa;
            min-height: 150px;
        }

        .panel-display h3 {
            margin-top: 0;
            font-size: 1rem;
            color: #333;
            border-bottom: 1px solid #ddd;
            padding-bottom: 0.5rem;
            margin-bottom: 0.8rem;
        }

        .panel-content-display {
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .unlock-button {
            position: absolute;
            top: -3rem;
            right: 0;
            background-color: #6c757d;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
            border-radius: 5px;
            cursor: pointer;
        }

        .unlock-button:hover {
            background-color: #545b62;
        }

        .unlock-button.unlocked {
            background-color: #28a745;
        }

        .unlock-button:disabled {
            background-color: #adb5bd;
            cursor: not-allowed;
        }

        @media (max-width: 768px) {
            .four-panel-layout {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 480px) {
            .four-panel-layout {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <h1 class="page-title">Auto Feedback Generation</h1>
   <!-- Display current tid at top right -->
    <div id="tid-display" style="position: absolute; top: 1rem; right: 2rem; color: #999; font-size: 0.9rem;">
        Current tid is: <span id="tid-value">N/A</span>
    </div>

    <div class="container">
        <!-- Navigation Buttons -->
        <div class="navigation-buttons">
            <button class="back-button" onclick="goBack()">Back</button>
            <button class="save-button" onclick="saveConfiguration()">Save & Complete</button>
        </div>

        <!-- System Configuration Display -->
        <div class="section" id="details-display">
            <h2>Your Feedback System Configuration:</h2>
            <!-- <div style="margin-bottom: 1.5rem;">
                <button class="conf-btn" style="background-color: #ff9800;" data-index="0">conf 1</button>
                <button class="conf-btn" style="background-color: #ff9800;" data-index="1">conf 2</button>
                <button class="conf-btn" style="background-color: #ff9800;" data-index="2">conf 3</button>
                <button class="conf-btn" style="background-color: #ff9800;" data-index="3">conf 4</button>
            </div> -->
            <div class="four-panel-layout">
                <!-- Unlock/Lock button for all panels -->
                <!-- <button class="unlock-button" id="unlock-settings-btn" onclick="toggleLockSettings()">---</button> -->
                

                <!-- Panel 1: Style Keywords -->
                <div class="panel-display" id="panel-style-keywords">
                    <h3>Style Keywords</h3>
                    <div class="panel-content-display" id="style-keywords-display"></div>
                </div>

                <!-- Panel 2: Feedback Templates -->
                <div class="panel-display" id="panel-feedback-templates">
                    <h3>Feedback Template</h3>
                    <div class="panel-content-display" id="feedback-templates-display"></div>
                </div>

                <!-- Panel 3: Teaching Style -->
                <div class="panel-display" id="panel-teach-style">
                    <h3>Feedback Pattern</h3>
                    <div class="panel-content-display" id="teach-style-display"></div>
                </div>

                <!-- Panel 4: Teaching Example -->
                <div class="panel-display" id="panel-teach-example">
                    <h3>Your Feedback Example</h3>
                    <div class="panel-content-display" id="teach-example-display"></div>
                </div>
            </div>
        </div>

        <!-- Student Answer Input -->
        <div class="section" id="question-display">
            <p>Find the derivative of each of the following functions. You do not need to simplify your answers.</p>
            <p>(a) f(x) = x<sup>ln(x)</sup></p>
        </div>

        <!-- Student Answer Input -->
        <div class="section" id="student-input">
            <h2>Student Answer Input</h2>
            <div id="sampleAnswerButtons" style="margin-bottom: 15px;">
                <button class="sample-btn" data-index="0">ans1</button>
                <button class="sample-btn" data-index="1">ans2</button>
                <button class="sample-btn" data-index="2">ans3</button>
                <button class="sample-btn" data-index="3">ans4</button>
                <button class="sample-btn" data-index="4">ans5</button>
            </div>
            <div id="textInputArea">
                <textarea id="student-answer" placeholder="Write the student answer here..."></textarea>
            </div>
            <br>
            <button id="generateFeedbackBtn">Generate Feedback</button>
        </div>

        <!-- Feedback Result Display -->
        <div class="section" id="feedback-display" style="display: none;">
            <h2>Generated Feedback</h2>
            <div id="result-textarea"
                style="white-space: pre-line;
                        border: 1px solid #ccc;
                        padding: 8px;
                        min-height: 120px;
                        font-family: inherit;
                        background-color: #f9f9f9;
                        overflow-y: auto;">
                Generating Feedback...
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/feedback_input_function.js') }}"></script>
    <script>
        // User authentication check
        function checkAuthentication() {
            const user = localStorage.getItem('user');
            if (!user) {
                alert('Please login first to access this page.');
                window.location.href = '/login';
                return false;
            }
            return true;
        }
        
        // Initialize authentication check on page load
        if (!checkAuthentication()) {
            throw new Error('Authentication required');
        }
        
        // Global variables - avoid redeclaration conflict with feedback_input_function.js
        let isStyleLocked = false;  // From backend data (renamed to avoid conflict)
        let lockedStyleTmp = true;  // Local variable for UI control (renamed to avoid conflict)
        let currentConfig = {
            style_keywords: ['calculas teacher'],
            feedback_templates: ['strength', 'weakness', 'improvement'],
            teach_style: '',
            teach_example: ''
        };
        
        sessionStorage['userId'] = 'test';
        
        // Navigation functions
        function goBack() {
            window.location.href = '/step2';
        }
        
        function saveConfiguration() {
            const finalConfig = {
                'tid': sessionStorage.getItem('tid') || crypto.randomUUID(),
                'finalConfiguration': {
                    'timestamp': new Date().toISOString(),
                    'completed': true
                }
            };
            
            fetch('/api/configuration/final', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(finalConfig)
            }).then(response => response.json())
            .then(result => {
                if (result.success) {
                    alert('✅ Configuration saved successfully! Your feedback system is ready to use.');
                } else {
                    alert('❗ Save failed. Please try again.');
                }
            }).catch(error => {
                console.error('Save error:', error);
                alert('❗ An error occurred while saving. Please try again.');
            });
        }
        
        // Lock/Unlock functionality
        // function toggleLockSettings() {
        //     if (isStyleLocked) return; // Cannot toggle if locked from backend
            
        //     lockedStyleTmp = !lockedStyleTmp;
            
        //     if (!lockedStyleTmp) {
        //         // Unlocking - switch to edit mode
        //         loadEditableComponents();
        //     } else {
        //         // Locking - save current state and switch to display mode
        //         updateCurrentConfigFromUI();
        //         saveCurrentConfiguration();
        //         displayConfigurationAsText();
        //     }
            
        //     updateLockButtonState();
        // }
        
        // function updateLockButtonState() {
        //     const button = document.getElementById('unlock-settings-btn');
            
        //     if (isStyleLocked) {
        //         button.textContent = 'Locked';
        //         button.disabled = true;
        //         button.classList.remove('unlocked');
        //         lockedStyleTmp = true;
        //     } else {
        //         button.textContent = lockedStyleTmp ? 'Setting O' : 'Setting L';
        //         button.disabled = false;
        //         button.classList.toggle('unlocked', !lockedStyleTmp);
        //     }
        // }
        
        // Load configuration data from stored sources
        function loadConfiguredSystem() {
            const configData = window.feedbackInputFunctions.getStoredConfigData();
            
            currentConfig = {
                style_keywords: configData.style_keywords,
                feedback_templates: configData.feedback_templates,
                teach_style: configData.teach_style || 'tp0',
                teach_example: configData.teach_example
            };
            
            // Check if style is locked from previous steps
            isStyleLocked = configData.locked_style;
            
            // Initialize UI state
            // updateLockButtonState();
            
            console.log('Loaded configuration:', currentConfig);
            
            // Display configuration
            displayConfigurationAsText();
        }
        
        // Display configuration as text in four panels
        function displayConfigurationAsText() {
            // Style Keywords
            const styleDisplay = document.getElementById('style-keywords-display');
            const styleText = currentConfig.style_keywords.length > 0 
                ? currentConfig.style_keywords.join(', ') 
                : 'N/A';
            styleDisplay.textContent = styleText;

            // Feedback Templates  
            const templateDisplay = document.getElementById('feedback-templates-display');
            const templateDefault = ['- Strength', '- Weakness', '- Improvement'];

            let lines;
            if (currentConfig.feedback_templates.length > 0) {
                lines = currentConfig.feedback_templates.map((t, i) => `${i + 1}. ${t}`);
            } else {
                const defaultLines = templateDefault.map((t, i) => `${i + 1}. ${t}`);
                lines = ['[Default Template]', ...defaultLines];
            }

            const templateText = lines.join('\n');
            templateDisplay.style.whiteSpace = 'pre-line';
            templateDisplay.textContent = templateText;
            
            // Teaching Style
            const styleDisplay2 = document.getElementById('teach-style-display');
            styleDisplay2.textContent = currentConfig.teach_style || 'N/A';
            
            // Teaching Example
            const exampleDisplay = document.getElementById('teach-example-display');
            exampleDisplay.style.whiteSpace = 'pre-line';
            exampleDisplay.textContent = currentConfig.teach_example || 'No Example Provided';
        }
        
        // Load editable components (when unlocked)
        async function loadEditableComponents() {
            try {
                // This is a placeholder - in practice, you'd load the component HTML files
                // and initialize them for editing
                console.log('Loading editable components...');
                
                // For now, just switch back to display mode
                displayConfigurationAsText();
                
            } catch (error) {
                console.error('Failed to load editable components:', error);
            }
        }
        
        function updateCurrentConfigFromUI() {
            // This would update currentConfig with current UI values when in edit mode
            // For now, keep existing values
            console.log('Updating config from UI...');
        }
        
        // Save current configuration to backend
        function saveCurrentConfiguration() {
            const tid = sessionStorage.getItem('tid') || crypto.randomUUID();
            
            const styleData = {
                'tid': tid,
                'style_keywords': currentConfig.style_keywords,
                'feedback_templates': currentConfig.feedback_templates,
                'teach_style': currentConfig.teach_style,
                'teach_example': currentConfig.teach_example
            };
            
            console.log('Saving configuration:', styleData);
            
            fetch('/api/comment/update_style', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(styleData)
            }).then(response => response.json())
            .then(result => {
                if (result.success) {
                    console.log('Configuration saved successfully');
                } else {
                    console.error('Failed to save configuration:', result);
                }
            }).catch(error => {
                console.error('Error saving configuration:', error);
            });
        }
        
        // Student input and feedback generation functionality
        document.addEventListener('DOMContentLoaded', function() {
            const generateFeedbackBtn = document.getElementById('generateFeedbackBtn');
            const feedbackDisplay = document.getElementById("feedback-display");
            const tid = sessionStorage.getItem('tid') || 'N/A';
            
            document.getElementById('tid-value').textContent = tid;

            generateFeedbackBtn.addEventListener('click', function () {
                const studentAnswer = document.getElementById('student-answer').value.trim();
                if (!studentAnswer) {
                    alert('Please enter a student answer before generating feedback.');
                    return;
                }
                
                feedbackDisplay.style.display = 'block';
                document.getElementById('result-textarea').value = 'Generating Feedback...';
                generatePersonalizedFeedback();
            });
            
            // Load configuration when page loads
            loadConfiguredSystem();
        });
        
        function generatePersonalizedFeedback() {
            const studentAnswer = document.getElementById('student-answer').value;
            const resultBox = document.getElementById('result-textarea');
            const tid = sessionStorage.getItem('tid') || crypto.randomUUID();
            const archive_tid = sessionStorage.getItem('archive_tid') || '';
            const predefined_flag = sessionStorage.getItem('predefined_conf') || '';
            
            // Preparing to submit data
            const submitData = {
                'tid': tid,
                'archive_tid': archive_tid,
                'student_answer': studentAnswer,
                'style_keywords': currentConfig.style_keywords,
                'feedback_templates': currentConfig.feedback_templates,
                'teach_style': currentConfig.teach_style,
                'teach_example': currentConfig.teach_example,
                'predefined_flag': predefined_flag
            };
            
            console.log('Submitting feedback request:', submitData);
            
            // Step 1: Call /api/comment/submit to generate feedback.
            fetch('/api/comment/submit', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(submitData)
            })
            .then(response => response.json())
            .then(submitResult => {
                if (submitResult.success) {
                    console.log('Feedback generation submitted successfully');
                    let attempt_id=submitResult.attempt_id
                    // Step 2: Call /api/comment/load to retrieve the formatted feedback text.
                    return fetch(`/api/comment/load?tid=${tid}&attempt_id=${attempt_id}`, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                } else {
                    throw new Error(submitResult.error || 'Feedback generation failed');
                }
            })
            .then(response => response.json())
            .then(loadResult => {
                if (loadResult.success) {
                    console.log('Feedback loaded successfully');

                    const htmlText  = loadResult.response;  
                    // 1. First render the main body (with <strong>, <span color>, <br>, etc.).
                    resultBox.innerHTML = htmlText;

                    // 2. Add configuration information at the end (use <hr> with 15 horizontal lines for a simpler style)
                    resultBox.innerHTML += `
                    <hr style="margin:1rem 0;border:none;border-top:1px solid #ccc;">
                    <div style="color:#fb827a;">
                    Generated using: ${currentConfig.teach_style} style<br>
                    Keywords: ${currentConfig.style_keywords.join(', ') || 'DEV: Default Traits'}<br>
                    Templates: ${currentConfig.feedback_templates.join(', ') || 'DEV: Default Structure'}
                    </div>`;
                    
                } else {
                    throw new Error(loadResult.error || 'Failed to load formatted feedback');
                }
            })
            .catch(error => {
                console.error('Error generating feedback:', error);
                
                // If the API call fails, display an error message.
                resultTextarea.value = `❌ Error generating feedback: ${error.message}. Please try again or check your configuration.`;
            });
        }


        // Pre-defined configuration sets for demo
        // const predefinedConfigs = [
        //     {
        //         style_keywords: ['Motivating', 'Positive'],
        //         feedback_templates: ['strength', 'weakness', 'improvement'],
        //         teach_style: 'SOCRATIC',
        //         teach_example: ''
        //     },
        //     {
        //         style_keywords: ['Humor', 'Creative'],
        //         feedback_templates: ['Answer Analysis', 'Suggestion', 'Follow-up Question'],
        //         teach_style: 'NURTURING ',
        //         teach_example: ''
        //     },
        //     {
        //         style_keywords: ['Motivating', 'Positive'],
        //         feedback_templates: ['strength', 'weakness', 'improvement'],
        //         teach_style: 'SOCRATIC',
        //         teach_example: '- INCREDIBLE! Your u-substitution EXPLODED that integral into pure pi/2 ELEGANCE. Keep riding that WAVE of algebraic LIGHTNING!; // - WOW! You TAMED the Taylor series; the terms lined up like a rocket launch and BLASTED toward e^x PERFECTION—stay in this ORBIT! // - FANTASTIC! Your epsilon-delta BALLET DANCED the limit right into zero\'s arms—let this ENERGY FUEL every proof ahead! %% [HIGH ENERGY EXCITEMENT STYLE]'
        //     },
        //     {
        //         style_keywords: ['Motivating', 'Positive'],
        //         feedback_templates: ['strength', 'weakness', 'improvement'],
        //         teach_style: 'SOCRATIC',
        //         teach_example: '- PICTURE your Riemann sum as tiny LEGO bricks—SNAP, they stack into a smooth curved ramp under your pencil! // - IMAGINE the derivative as a zoom lens—your focus TWISTED and the slope POPPED into crystal-clear view! // - VISUALIZE the volume integral as onion layers—your integral PEELS each ring and stacks them into a perfect SPHERE of area! %% [VISUAL METAPHOS ANALOGY STYLE]'
        //     }
        // ];

        // // Load configuration from predefined set
        // function loadPredefinedConfig(index) {
        //     if (index < 0 || index >= predefinedConfigs.length) {
        //         return;
        //     }
            
        //     const config = predefinedConfigs[index];
        //    // Set new configuration to sessionStorage
        //     sessionStorage.setItem('step1_style_keywords', config.style_keywords.join('\n'));
        //     sessionStorage.setItem('step1_feedback_templates', config.feedback_templates.join('\n'));
        //     sessionStorage.setItem('step2_selected_teach_style', config.teach_style);
        //     sessionStorage.setItem('step2_teach_example', config.teach_example);
            
        //    // Reload configuration to update page display
        //     loadConfiguredSystem();
        //     sessionStorage.setItem('predefined_conf', index)
        // }

        // // Add event listeners to configuration buttons
        // document.querySelectorAll('.conf-btn').forEach(btn => {
        //     btn.addEventListener('click', function() {
        //         const index = parseInt(this.dataset.index);
        //         loadPredefinedConfig(index);
        //     });
        // });

        // Tmp: give pre-defined answers for demo
        const sampleAnswers = [
            "Take ln on both sides, differentiate: f′(x) = x^(ln x + 1). Easy!",
            "Oops, I forgot the chain bit: f′(x) = x^·ln x. Still looks neat.",
            "Power rule only, right? f′(x) = ln x·x^. Voilà!",
            "Wait, derivative of ln x is 1/x, so f′(x) = x^·(1/x). Done.",
            "Mixed up everything: f′(x) = ln x·x^ + x^. Whatever, close enough."
        ];

        document.querySelectorAll('.sample-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const index = parseInt(this.dataset.index);
                document.getElementById('student-answer').value = sampleAnswers[index];
            });
        });
    </script>
</body>
</html>