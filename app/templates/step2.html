<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>>Step 2/2: Feedback Pattern and Personalization</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/general.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/feedback_input_function.css') }}">
</head>
<body>
    <h1 class="page-title">Auto Feedback Generation</h1>
    <div class="container">
        <div class="left-section">
            <h2 style="text-decoration: underline;">Configure Feedback Patterns</h2>
            <p id="save-status"></p>
            
            <ul class="instruction-list">
                <li id="step-1-text">Select your <b>Primary Feedback Pattern</b></li>
                <li id="step-2-text">Add your <b>Personalized Feedback Example</b></li>
                <li id="step-3-text">Review and Finalize Settings</li>
            </ul>

            <div class="traverse-buttons">
                <button class="t-button" onclick="goBack()">Back</button>
                <button class="t-button" onclick="saveAndProceed()">Save</button>
            </div>
        </div>

        <div class="right-section">
            <!-- Component 3: Teaching Style -->
            <div class="content-section" id="teaching-style-section">
                <div id="feedback-function-3-container"></div>
            </div>

            <hr style="margin: 2rem 0; border: 1px solid #ddd;">

            <!-- Component 4: Teaching Example -->
            <div class="content-section" id="teaching-example-section">
                <div id="feedback-function-4-container"></div>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/feedback_input_function.js') }}"></script>
    <script>
        // User authentication check
        function checkAuthentication() {
            const user = localStorage.getItem('user');
            if (!user) {
                alert('Please login first to access this page.');
                window.location.href = '/login';
                return false;
            }
            return true;
        }
        
        // Initialize authentication check on page load
        if (!checkAuthentication()) {
            throw new Error('Authentication required');
        }
        
        // Load components
        async function loadComponents() {
            try {
                // Load component 3
                const response3 = await fetch("{{ url_for('static', filename='templates/feedback_function_3.html') }}");
                const html3 = await response3.text();
                document.getElementById('feedback-function-3-container').innerHTML = html3;
                
                // Load component 4
                const response4 = await fetch("{{ url_for('static', filename='templates/feedback_function_4.html') }}");
                const html4 = await response4.text();
                document.getElementById('feedback-function-4-container').innerHTML = html4;
                
                // Initialize components after loading
                setTimeout(() => {
                    window.feedbackInputFunctions.initTeachingStyleComponent();
                    window.feedbackInputFunctions.initTeachingExampleComponent();
                }, 100);
                
            } catch (error) {
                console.error('Failed to load components:', error);
            }
        }
        
        // Navigation functions
        function goBack() {
            window.location.href = '/step1';
        }
        
        // Save and proceed to step_final
        function saveAndProceed() {
            const teachingStyle = window.feedbackInputFunctions.getSelectedTeachingStyle();
            const additionalInstructions = window.feedbackInputFunctions.getAdditionalInstructions();
            let tid = sessionStorage.getItem('tid');
            
            // Create session ID if it doesn't exist
            if (!tid) {
                tid = crypto.randomUUID();
                sessionStorage.setItem('tid', tid);
            }
            
            if (!teachingStyle) {
                alert("‚ùó Please select a teaching style. // Personalized Feedback Style");
                return;
            }
            
            // Get step1 data from localStorage
            const configData = window.feedbackInputFunctions.getStoredConfigData();
            
            // Prepare data for backend
            const styleData = {
                'tid': tid,
                'style_keywords': configData.style_keywords,
                'feedback_templates': configData.feedback_templates,
                'teach_style': teachingStyle,
                'teach_example': additionalInstructions || ''
            };
            
            console.log('Sending styleData to backend:', styleData);
            
            // Show saving status
            const status = document.getElementById('save-status');
            status.textContent = 'üíæ Saving...';
            status.style.color = 'blue';
            
            fetch('/api/comment/update_style', {
                method: 'POST', 
                headers: {
                    'Content-Type': 'application/json'
                }, 
                body: JSON.stringify(styleData)
            }).then(response => {
                if (!response.ok) {
                    throw Error('Save failed! Please try again.');
                }
                return response.json()
            }).then(result => {
                if (result.success) {
                    status.textContent = '‚úîÔ∏è Saved';
                    status.style.color = 'green';
                    
                    // Redirect to step_final after successful save
                    setTimeout(() => {
                        window.location.href = '/step_final';
                    }, 1000);
                } else {
                    console.log("Failed result is", result);
                    throw Error('Save failed! Please try again.');
                }
            }).catch(error => {
                console.error(error);
                status.textContent = '‚ùå Save failed';
                status.style.color = 'red';
                alert(error);
            });
        }
        
        // Initialize page
        window.addEventListener('load', loadComponents);
        
        // Auto-clear save status when user makes changes
        document.addEventListener('change', function() {
            const status = document.getElementById('save-status');
            if (status.textContent) {
                status.textContent = '';
                status.style.color = '';
            }
        });
    </script>
</body>
</html>
